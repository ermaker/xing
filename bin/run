#!/usr/bin/env ruby

require 'dotenv'
Dotenv.load
require 'bundler/setup'
require 'xing'
require 'mshard'
require 'logger'

logger = Logger.new(STDOUT)

def continue?
  MShard::MShard.new.get(:notify) != 'stop'
end

def notify contents
  MShard::MShard.new.set_safe(pushbullet: true, type: :note, title: contents)
end

loop do
  if continue?
    begin
      leverage = Xing::API.tr(:t1901, shcode: '122630')
      logger.debug { "Leverage: #{leverage['response']['price']}" }
      if leverage < 9365
        notify("Leverage: #{leverage['response']['price']}")
        logger.info { "Leverage: #{leverage['response']['price']}" }
      end
    end

    begin
      inverse = Xing::API.tr(:t1901, shcode: '114800')
      logger.debug { "Inverse: #{inverse['response']['price']}" }
      if inverse > 8500
        notify("Inverse: #{inverse['response']['price']}")
        logger.info { "Inverse: #{inverse['response']['price']}" }
      end
    end
  else
    logger.debug { 'Stopped. Passing' }
  end

  sleep 60
end
